# 종합 비교 분석

## 3단계 비교표

| 항목                    | Phase 3<br/>(단일 인스턴스) | Phase 4<br/>(Scale-out) | Phase 5<br/>(Scale-out + PgBouncer) | Phase 4 효과 | Phase 5 효과 |
| ----------------------- | --------------------------- | ----------------------- | ----------------------------------- | ------------ | ------------ |
| **응답 시간**           |
| p50 latency             | 258 ms                      | 744 ms                  | 790 ms                              | +188% 악화   | +6.2% 악화   |
| p95 latency             | 10,714 ms                   | 4,431 ms                | 4,395 ms                            | -58.6% 개선  | -0.8% 개선   |
| **처리량**              |
| RPS                     | 100.5 req/s                 | 712.4 req/s             | 713.0 req/s                         | +609% 증가   | +0.1% 증가   |
| 요청 실패율             | 1.22%                       | 2.02%                   | 2.00%                               | +65.6% 악화  | -1.0% 개선   |
| **리디렉션 지연**       |
| redirect_latency p(95)  | 154,583 ms                  | 9,239 ms                | 9,376 ms                            | -94.0% 개선  | +1.5% 악화   |
| **연결 관련**           |
| http_req_blocked p(95)  | 7,686 ms                    | 911 ms                  | 883 ms                              | -88.1% 개선  | -3.1% 개선   |
| http_req_connecting p(95) | 830 ms                    | 450 ms                  | 465 ms                              | -45.8% 개선  | +3.3% 악화   |

**참고**:

- 전체 요청 시간(`http_req_duration`)은 네트워크 지연을 포함합니다.
- Phase 3는 단일 인스턴스, Phase 4와 Phase 5는 10개 인스턴스로 실행되었습니다.

---

## 각 전략의 효과 분석

### Scale-out 효과 (Phase 3 → Phase 4)

**주요 개선**:

- **처리량**: 100.5 req/s → 712.4 req/s (+609% 증가) - 가장 큰 개선
- **p95 응답 시간**: 10.7초 → 4.4초 (-58.6% 개선)
- **리디렉션 지연 p(95)**: 154.6초 → 9.2초 (-94.0% 개선)
- **연결 블로킹 시간 p(95)**: 7.7초 → 0.9초 (-88.1% 개선)

**문제점**:

- **요청 실패율**: 1.22% → 2.02% (+65.6% 악화)
- **p50 응답 시간**: 258 ms → 744 ms (+188% 악화)
- **연결 풀 경합**: 10개 인스턴스 × 50개 연결 풀 = 500개 (PostgreSQL 최대 연결 수와 일치)

**결론**:

Scale-out은 처리량을 크게 향상시켰으며, p95 응답 시간과 리디렉션 지연을 대폭 개선했습니다. 하지만 연결 풀 경합 문제가 발생하여 요청 실패율이 증가하고 p50 응답 시간이 악화되었습니다.

**정량적 효과**:

- **처리량 (RPS)**: 100.5 → 712.4 (+609% 증가)
- **전체 요청 시간 (http_req_duration)**:
  - p50 latency: 258 ms → 744 ms (+188% 악화)
  - p95 latency: 10,714 ms → 4,431 ms (-58.6% 개선)
  - 평균: 2,244 ms → 1,284 ms (-42.8% 개선)
- **리디렉션 지연 (redirect_latency)**:
  - p95 latency: 154,583 ms → 9,239 ms (-94.0% 개선)
  - 평균: 30,903 ms → 3,397 ms (-89.0% 개선)
- **연결 블로킹 시간 (http_req_blocked)**:
  - p95 latency: 7,686 ms → 911 ms (-88.1% 개선)
- **요청 실패율**: 1.22% → 2.02% (+65.6% 악화)

### PgBouncer 효과 (Phase 4 → Phase 5)

**주요 개선**:

- **연결 풀 경합 해소**: `SHOW POOLS` 결과에서 `cl_waiting = 0`, `maxwait = 0` 확인
- **PostgreSQL 연결 수 감소**: 500개 → 200개 (60% 감소)
- **요청 실패율**: 2.02% → 2.00% (-1.0% 개선)
- **연결 블로킹 시간 p(95)**: 911ms → 883ms (-3.1% 개선)

**한계**:

- **전체 응답 시간**: p95 응답 시간은 4.4초에서 4.4초로 거의 변화 없음
- **p50 응답 시간**: 744ms → 790ms (+6.2% 악화)
- **리디렉션 지연**: 9.2초 → 9.4초 (+1.5% 악화)

**결론**:

PgBouncer는 연결 풀 경합 문제를 성공적으로 해소했으며, PostgreSQL 서버 부하를 감소시켰습니다. 하지만 전반적인 응답 시간에는 큰 영향을 주지 않았습니다. 이는 다른 성능 병목(애플리케이션 로직, 쿼리 최적화 등)이 존재함을 시사합니다.

**정량적 효과**:

- **전체 요청 시간 (http_req_duration)**:
  - p50 latency: 744 ms → 790 ms (+6.2% 악화)
  - p95 latency: 4,431 ms → 4,395 ms (-0.8% 개선)
  - 평균: 1,284 ms → 1,310 ms (+2.0% 악화)
- **연결 블로킹 시간 (http_req_blocked)**:
  - p95 latency: 911 ms → 883 ms (-3.1% 개선)
- **요청 실패율**: 2.02% → 2.00% (-1.0% 개선)
- **처리량 (RPS)**: 712.4 → 713.0 (+0.1% 증가)

---

## 종합 효과 (Phase 3 → Phase 5)

**전체 개선**:

- **처리량**:
  - RPS: 100.5 → 713.0 (+610% 증가)
- **응답 시간**:
  - p50 latency: 258 ms → 790 ms (+206% 악화)
  - p95 latency: 10,714 ms → 4,395 ms (-59.0% 개선)
  - 평균: 2,244 ms → 1,310 ms (-41.6% 개선)
- **리디렉션 지연**:
  - p95 latency: 154,583 ms → 9,376 ms (-93.9% 개선)
  - 평균: 30,903 ms → 3,419 ms (-88.9% 개선)
- **연결 블로킹 시간**:
  - p95 latency: 7,686 ms → 883 ms (-88.5% 개선)
- **요청 실패율**: 1.22% → 2.00% (+64.0% 악화)

**전략 조합의 효과**:

Scale-out과 PgBouncer를 함께 사용하면:

- **Scale-out**: 처리량을 크게 향상시키고 p95 응답 시간을 개선
- **PgBouncer**: 연결 풀 경합을 해소하여 PostgreSQL 서버 부하 감소

하지만 p50 응답 시간과 요청 실패율은 여전히 개선이 필요합니다.

---

## 결론 및 인사이트

### 핵심 발견사항

1. **Scale-out의 효과**

   - 처리량을 7배 이상 증가 (100.5 → 712.4 req/s)
   - p95 응답 시간을 58.6% 개선 (10.7초 → 4.4초)
   - 리디렉션 지연을 94.0% 개선 (154.6초 → 9.2초)
   - 하지만 연결 풀 경합으로 인한 문제 발생

2. **PgBouncer의 효과**

   - 연결 풀 경합 문제 해소 (`cl_waiting = 0`, `maxwait = 0`)
   - PostgreSQL 서버 연결 수를 60% 감소 (500개 → 200개)
   - 하지만 전반적인 응답 시간에는 큰 영향을 주지 않음

3. **전략 조합의 중요성**
   - Scale-out은 처리량 향상에 필수적
   - PgBouncer는 Scale-out 시 연결 풀 경합 문제 해소에 필수적
   - 하지만 여전히 다른 성능 병목이 존재 (p50 응답 시간, 요청 실패율)

### 성능 병목 분석

**남아있는 병목**:

- **p50 응답 시간**: Scale-out 후 오히려 악화 (258 ms → 790 ms)
- **요청 실패율**: Phase 3 대비 증가 (1.22% → 2.00%)
- **p95 응답 시간**: 여전히 4.4초로 높음 (목표: <500ms)

**가능한 원인**:

- 애플리케이션 로직 최적화 필요
- 데이터베이스 쿼리 최적화 필요
- Redis 캐시 효율성 개선 필요
- 네트워크/인프라 구성 최적화 필요

---

## 참고 자료

- [Phase 3: 캐시 적용 (Step1)](../step1/phase3-cache.md)
- [Phase 4: Scale-out 적용](./phase4-scale-out.md)
- [Phase 5: PgBouncer 적용](./phase5-pgbouncer.md)
- [Step1 종합 비교 분석](../step1/comparison.md)
